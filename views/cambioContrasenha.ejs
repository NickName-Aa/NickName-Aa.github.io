<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/resources/css/base.css">
    <link rel="stylesheet" href="/resources/css/nueva.css">
    <title>Nueva contraseña</title>
</head>

<body>
    <div class="card">

        <% if (expired) { %>

    <p class="error">El enlace ha expirado o ya fue utilizado.</p>
    <a href="/olvidoContrasenha">Solicitar nuevo enlace</a>

<% } else if (success) { %>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        Swal.fire({
            title: 'Éxito',
            text: 'Contraseña cambiada correctamente',
            icon: 'success',
            timer: 2000,
            showConfirmButton: false
        }).then(() => {
            window.location.href = '/login';
        });
    </script>
    <p class="success">Contraseña cambiada correctamente.</p>
    <a href="/login">Ir al login</a>

<% } else { %>

    <% if (error) { %>
        <p class="error"><%= error %></p>
    <% } %>
<% if (token) { %>
    <form id="formCambio" action="/cambioContrasenha/<%= token %>" method="post">
    <img src="/resources/img/logo.png" alt="Logo" style="width: 150px;" class="mb-4 mx-auto">
    <label>Nueva contraseña</label>
    <input type="password" id="password" name="password" required>

    <label>Confirmar contraseña</label>
    <input type="password" id="confirmPassword" name="confirmPassword" required>

    <ul id="passwordChecklist">
        <li id="checkLength" class="invalid">8-16 caracteres</li>
        <li id="checkUpper" class="invalid">Al menos 1 mayúscula</li>
        <li id="checkNumber" class="invalid">Al menos 1 número</li>
        <li id="checkMatch" class="invalid">Contraseñas coinciden</li>
    </ul>

    <button type="submit" id="btnCambiar" disabled>Cambiar contraseña</button>
    </form>

<% } %>

<% } %>

    </div>
</body>
<script>
const passwordInput = document.getElementById('password');
const confirmInput = document.getElementById('confirmPassword');
const btnCambiar = document.getElementById('btnCambiar');

const checkLength = document.getElementById('checkLength');
const checkUpper = document.getElementById('checkUpper');
const checkNumber = document.getElementById('checkNumber');
const checkMatch = document.getElementById('checkMatch');

function validarPassword() {
    const pass = passwordInput.value;
    const confirm = confirmInput.value;

    // Validaciones
    const lengthValid = pass.length >= 8 && pass.length <= 16;
    const upperValid = /[A-Z]/.test(pass);
    const numberValid = /[0-9]/.test(pass);
    const matchValid = pass === confirm && pass.length > 0;

    // Actualizar checklist
    checkLength.className = lengthValid ? "valid" : "invalid";
    checkUpper.className = upperValid ? "valid" : "invalid";
    checkNumber.className = numberValid ? "valid" : "invalid";
    checkMatch.className = matchValid ? "valid" : "invalid";

    // Habilitar botón solo si todo es válido
    btnCambiar.disabled = !(lengthValid && upperValid && numberValid && matchValid);

    return lengthValid && upperValid && numberValid && matchValid;
}

passwordInput.addEventListener('input', validarPassword);
confirmInput.addEventListener('input', validarPassword);

document.getElementById('formCambio').addEventListener('submit', function(e) {
    if (!validarPassword()) {
        e.preventDefault();
        alert("La contraseña no cumple con los requisitos.");
    }
});
</script>
</html>